name: Sync GitHub Rulesets

on:
  push:
    branches:
      - main
    paths:
      - ".github/rulesets/**"

permissions:
  contents: read
  # This is important – admin/rules permission
  administration: write

jobs:
  sync-rulesets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync rulesets from JSON files
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const rulesetsDir = path.join(process.cwd(), '.github', 'rulesets');

            // read all json files in .github/rulesets
            const files = fs.readdirSync(rulesetsDir)
              .filter(f => f.endsWith('.json'));

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            for (const file of files) {
              const fullPath = path.join(rulesetsDir, file);
              const data = JSON.parse(fs.readFileSync(fullPath, 'utf8'));

              // We’ll assume each JSON has either:
              // - an "id" field (update existing ruleset), or
              // - no "id" (create a new one if not found by name)
              const name = data.name;
              if (!name) {
                core.setFailed(`Ruleset file ${file} has no "name" property.`);
                continue;
              }

              // Remove id if present; the REST API usually takes it in the URL, not body
              const { id, ...body } = data;

              core.info(`Syncing ruleset: ${name} (file: ${file})`);

              // 1. List existing rulesets to check if one with same name exists
              const existing = await github.request(
                'GET /repos/{owner}/{repo}/rulesets',
                { owner, repo }
              );

              const match = existing.data.find(rs => rs.name === name);

              if (match) {
                core.info(`Found existing ruleset "${name}" (id: ${match.id}), updating...`);
                await github.request(
                  'PUT /repos/{owner}/{repo}/rulesets/{ruleset_id}',
                  {
                    owner,
                    repo,
                    ruleset_id: match.id,
                    ...body,
                  }
                );
              } else {
                core.info(`No existing ruleset "${name}" found, creating...`);
                await github.request(
                  'POST /repos/{owner}/{repo}/rulesets',
                  {
                    owner,
                    repo,
                    ...body,
                  }
                );
              }
            }
