# .github/workflows/hotfix-propagation-notifier.yml

name: Hotfix Propagation Notifier

# Permissions must be declared here to ensure the default GITHUB_TOKEN has the 
# necessary write access for labeling and commenting on the closed PR.
permissions:
  contents: read
  issues: write 
  pull-requests: write 

on:
  pull_request_target:
    types: [closed] 
    
jobs:
  generate_sop:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Generate and Post Hotfix Propagation SOP
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request; 

            const prNumber = pr.number;
            const hotfixBranch = pr.head.ref;
            const repoUrl = `https://github.com/${owner}/${repo}`;

            core.info(`Processing merged PR #${prNumber}`);
            
            // --- 1. Validation (Must be hotfix/* branch) ---
            if (!hotfixBranch.startsWith("hotfix/")) {
              core.info(`PR head '${hotfixBranch}' is not hotfix/* ‚Äî exiting.`);
              return;
            }

            core.info(`Confirmed hotfix PR: ${hotfixBranch}`);

            // --- 2. Label PR (Tracking) ---
            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: prNumber,
                labels: ["needs-propagation"], // Renamed label to reflect the process
              });
              core.info(`Applied label 'needs-propagation'.`);
            } catch (err) {
              core.warning(`Failed to apply label: ${err.message}`);
            }

            // --- 3. Build SOP data and instructions (SIMPLIFIED) ---
            
            // We only need the branch names for the PR links
            const stagingTarget = 'staging';
            const developTarget = 'develop';

            // --- Build Propagation Block Helper ---
            function buildPropagationBlock(target) {
              return [
                `### üìå Propagate to ${target.toUpperCase()}`,
                "<details>",
                "  <summary>Create PR: hotfix/* \u2192 " + target + "</summary>",
                "",
                "The **original** `hotfix` branch must be used to merge into the target branch.",
                "",
                `‚û°Ô∏è Create PR: [\`${hotfixBranch} \u2192 ${target}\`](${repoUrl}/compare/${target}...${hotfixBranch})`,
                "",
                "</details>",
              ].join('\n');
            }

            // --- 4. Assemble Final Message Blocks ---
            
            const blockSetup = ["### üîß 1. Sync Local Main", "```bash", "git checkout main", "git pull origin main", "```"].join('\n');
            const blockStaging = buildPropagationBlock(stagingTarget);
            const blockDevelop = buildPropagationBlock(developTarget);

            const blockCleanup = [
              "### üßπ 4. Cleanup (AFTER ALL PRs are Merged)",
              "<details>",
              "<summary>Remove the hotfix branch safely</summary>",
              "",
              "```bash",
              `git branch -D ${hotfixBranch}`,
              `git push origin :${hotfixBranch}`,
              "```",
              "‚ö†Ô∏è Only delete the branch once it has been successfully merged into **main**, **staging**, and **develop**.",
              "</details>",
            ].join('\n');

            const caveat = [
              "---",
              "### ‚ö†Ô∏è Safety Notes",
              "- You will open PRs: 1) `hotfix/*` \u2192 `staging`, and 2) `hotfix/*` \u2192 `develop`.",
              "- Resolve merge conflicts carefully.",
              "- Do **not** delete the hotfix branch until ALL propagation PRs are merged.",
            ].join("\n");


            const sop = [
              `## üî• Hotfix Propagation SOP: \`${hotfixBranch}\``,
              `This hotfix has merged into **main**. You must manually open PRs directly from this branch to propagate the fix to lower environments.`,
              "---",
              blockSetup,
              blockStaging,
              blockDevelop,
              blockCleanup,
              caveat,
            ].join('\n\n');

            // --- 5. Post SOP comment ---
            try {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: sop,
              });
              core.info(`SOP posted on PR #${prNumber}.`);
            } catch (err) {
              core.error(`Failed to post SOP comment: ${err.message}`);
              throw err;
            }