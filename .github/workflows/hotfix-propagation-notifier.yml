# .github/workflows/hotfix-propagation-notifier.yml

name: Hotfix Propagation Notifier

# This trigger runs *after* the PR is closed (merged) and provides high privilege
# to the token, which is necessary for reliably commenting on a closed PR.
permissions:
  contents: read
  issues: write # Required for adding labels and posting comments
  pull-requests: write # Required for reading PR details and adding labels/comments

on:
  pull_request_target:
    types: [closed]
    branches:
      - main # Only run when PR targets and merges into main

jobs:
  generate_sop:
    # Only runs if the pull request was merged (not just closed without merging)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Generate and Post Hotfix Backport SOP
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

          script: |
            const { owner, repo } = context.repo;
            const pr = github.event.pull_request;

            const prNumber = pr.number;
            const hotfixBranch = pr.head.ref;
            const baseBranch = pr.base.ref;

            core.info(`Processing merged PR #${prNumber}`);
            
            // --- 1. Validation (Ensure correct base and hotfix branch name) ---
            if (baseBranch !== "main") {
              core.info(`PR merged into '${baseBranch}', not main. Exiting.`);
              return;
            }

            if (!hotfixBranch.startsWith("hotfix/")) {
              core.info(`Not a hotfix PR (${hotfixBranch}). Exiting.`);
              return;
            }

            core.info(`Hotfix PR confirmed: ${hotfixBranch}`);

            // --- 2. Label PR (Tracking) ---
            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: prNumber,
                labels: ["needs-backport"],
              });
              core.info(`Label 'needs-backport' applied.`);
            } catch (err) {
              core.warning(`Failed to apply label: ${err.message}`);
            }

            // --- 3. Build SOP comment variables and checks ---
            const hotfixBase = hotfixBranch.split("/").pop();
            const stagingBackport = `backport/${hotfixBase}-to-staging`;
            const developBackport = `backport/${hotfixBase}-to-develop`;
            const repoUrl = `https://github.com/${owner}/${repo}`;

            // Utility function to check branch existence (remains robust)
            async function branchExists(branch) {
              try {
                await github.rest.repos.getBranch({ owner, repo, branch });
                return true;
              } catch (error) {
                if (error.status === 404) return false;
                throw error;
              }
            }

            const stagingExists = await branchExists(stagingBackport);
            const developExists = await branchExists(developBackport);

            // --- Build Backport Block Helper ---
            function buildBackportBlock(target, branchName, exists) {
              const base = target.toLowerCase();
              
              if (exists) {
                return [
                  `### ${target} Backport`,
                  "<details>",
                  `  <summary>‚ö†Ô∏è Branch already exists: <code>${branchName}</code></summary>`,
                  "",
                  `‚û°Ô∏è Open or inspect PR: [\`${branchName} \u2192 ${base}\`](${repoUrl}/compare/${base}...${branchName})`,
                  "",
                  "</details>",
                ].join('\n');
              }

              return [
                `### ${target} Backport`,
                "<details>",
                "  <summary>Create backport branch \u2192 Open PR</summary>",
                "",
                "```bash",
                `git checkout ${base}`,
                `git pull origin ${base}`,
                `git checkout -b ${branchName}`,
                `git merge ${hotfixBranch}`,
                `git push origin ${branchName}`,
                "```",
                "",
                `‚û°Ô∏è Create PR: [\`${branchName} \u2192 ${base}\`](${repoUrl}/compare/${base}...${branchName})`,
                "",
                "</details>",
              ].join('\n');
            }

            // --- 4. Assemble Final Message Blocks ---
            
            const blockSetup = [
              "### üîß 1. Sync Local Main",
              "```bash",
              "git checkout main",
              "git pull origin main",
              "```",
            ].join('\n');
            
            const blockStaging = buildBackportBlock("STAGING", stagingBackport, stagingExists);
            const blockDevelop = buildBackportBlock("DEVELOP", developBackport, developExists);

            const blockCleanup = [
              "### üßπ 4. Cleanup (AFTER all backports merge)",
              "<details>",
              "<summary>Remove leftover branches safely</summary>",
              "",
              "```bash",
              `git branch -D ${hotfixBranch}`,
              `git push origin :${hotfixBranch}`,
              "```",
              "‚ö†Ô∏è Only remove backport branches *after* merging them.",
              "</details>",
            ].join('\n');

            const caveat = [
              "---",
              "### ‚ö†Ô∏è Safety Notes",
              "- Resolve merge conflicts carefully.",
              "- Verify branch names before merging.",
              "- Do **not** delete the hotfix branch until both backport PRs are merged.",
            ].join("\n");


            const sop = [
              `## üî• Hotfix Backport SOP for \`${hotfixBranch}\``,
              `This hotfix PR has been merged into **main**. To complete the propagation flow, you must manually backport it to **staging** and **develop**.`,
              "---",
              blockSetup,
              blockStaging,
              blockDevelop,
              blockCleanup,
              caveat,
            ].join('\n\n');

            // --- 5. Post SOP comment ---
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: sop,
            });

            core.info(`SOP posted on PR #${prNumber}.`);