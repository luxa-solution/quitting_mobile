# .github/workflows/hotfix-propagation-notifier.yml

name: Hotfix Propagation Notifier

# Permissions must be declared here to ensure the default GITHUB_TOKEN has the 
# necessary write access for commenting on the closed PR.
permissions:
  contents: read
  issues: write # Required for posting the SOP comment
  pull-requests: write # Required for reading PR details

on:
  pull_request_target:
    types: [closed]

jobs:
  generate_sop:
    # Only run if the PR was merged AND targeted 'main'.
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Generate and Post Hotfix Propagation SOP
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;

            const prNumber = pr.number;
            const hotfixBranch = pr.head.ref;
            
            core.info(`Processing merged PR #${prNumber}`);

            if (!hotfixBranch.startsWith("hotfix/")) {
              core.info(`PR head '${hotfixBranch}' is not hotfix/* ‚Äî exiting.`);
              return;
            }

            core.info(`Confirmed hotfix PR: ${hotfixBranch}`);

            const repoUrl = `https://github.com/${owner}/${repo}`;

            // --- 1. Sequential Propagations (Manually written blocks) ---
            
            // WARNING FOR STEP 1: DEVELOP
            const warningDevelop = [
              "## ‚ö†Ô∏è SAFETY WARNING: STEP 1/2",
              "The fix **MUST** be applied to `develop` before proceeding to `staging`.",
              "---",
            ].join("\n");
            
            // BLOCK 1: HOTFIX -> DEVELOP
            const blockDevelop = [
              warningDevelop, 
              "### üìå 1. `hotfix/*` ‚Üí `develop`",
              "<details>",
              "  <summary>Create PR: hotfix ‚Üí develop</summary>",
              "",
              "```bash",
              `git checkout ${hotfixBranch}`,
              `git pull origin ${hotfixBranch}`,
              "```",
              "",
              `‚û°Ô∏è Create PR: [\`${hotfixBranch} \u2192 develop\`](${repoUrl}/compare/develop...${hotfixBranch})`,
              "",
              "</details>",
            ].join("\n");

            
            // WARNING FOR STEP 2: STAGING
            const warningStaging = [
              "---",
              "## ‚ö†Ô∏è SAFETY WARNING: STEP 2/2",
              "The fix must travel through `develop`. **Do not start this PR until Step 1 has merged.**",
              "---",
            ].join("\n");

            // BLOCK 2: DEVELOP -> STAGING
            const blockStaging = [
              warningStaging,
              "### üìå 2. `develop` ‚Üí `staging`",
              "<details>",
              "  <summary>Create PR: develop ‚Üí staging</summary>",
              "",
              "```bash",
              "git checkout develop",
              "git pull origin develop",
              "```",
              "",
              `‚û°Ô∏è Create PR: [\`develop \u2192 staging\`](${repoUrl}/compare/staging...develop)`,
              "",
              "</details>",
            ].join("\n");

            // --- 2. Cleanup section ---
            
            const blockCleanup = [
              "### üßπ 3. Cleanup (AFTER ALL PRs are Merged)",
              "<details>",
              "<summary>Remove hotfix branches safely</summary>",
              "",
              "```bash",
              `git switch develop # Switch to a stable branch`,
              `git branch -D ${hotfixBranch}`,
              `git push origin :${hotfixBranch}`,
              "```",
              "‚ö†Ô∏è Only delete the branch once it has been successfully merged into **main**, **develop**, and **staging**.",
              "</details>",
            ].join("\n");

            const finalCaveatNotes = [
              "---",
              "### General Safety Notes",
              "- Resolve merge conflicts carefully.",
              "- Do **not** delete the hotfix branch prematurely.",
            ].join("\n");

            // --- 3. Build full SOP ---
            
            const sop = [
              `## üî• Hotfix Propagation SOP: \`${hotfixBranch}\``,
              `This hotfix has merged into **main**. You must now propagate the fix using the workflow detailed below:`,
              "---",
              // Blocks are placed here, carrying their own warnings
              blockDevelop,
              blockStaging,
              blockCleanup,
              finalCaveatNotes,
            ].join("\n\n");

            // --- 4. Post SOP comment ---
            try {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: sop,
              });
              core.info(`SOP posted on PR #${prNumber}.`);
            } catch (err) {
              core.error(`Failed to post SOP comment: ${err.message}`);
              throw err;
            }