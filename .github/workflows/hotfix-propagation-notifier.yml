# .github/workflows/hotfix-propagation-notifier.yml

name: Hotfix Propagation Notifier

on:
  push:
    branches:
      - main

jobs:
  generate_sop:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Generate and Post Custom SOP
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const commitSha = context.sha;

            core.info(`Processing push event on main with commit: ${commitSha}`);

            // --- 1. Lookup PR associated with this merge commit ---
            const { data: searchResults } = await github.rest.search.issuesAndPullRequests({
              q: `sha:${commitSha} type:pr is:merged repo:${owner}/${repo} base:main`,
              sort: "updated",
              order: "desc",
              per_page: 1,
            });

            if (searchResults.total_count === 0) {
              core.info(`No merged PR found for commit ${commitSha}. Exiting.`);
              return;
            }

            const originalPrNumber = searchResults.items[0].number;

            // --- 2. Fetch PR details ---
            const { data: mergedPr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: originalPrNumber,
            });

            const hotfixBranch = mergedPr.head.ref;

            if (!hotfixBranch.startsWith("hotfix/")) {
              core.info(`Branch '${hotfixBranch}' is not hotfix/* ‚Äî skipping.`);
              return;
            }

            core.info(`Hotfix PR #${originalPrNumber} detected.`);

            // --- 3. Label PR ---
            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: originalPrNumber,
                labels: ["needs-backport"],
              });
              core.info(`Label 'needs-backport' added.`);
            } catch (err) {
              core.warning(`Labeling failed: ${err.message}`);
            }

            // --- 4. Branch existence detection ---
            async function branchExists(branch) {
              try {
                await github.rest.repos.getBranch({ owner, repo, branch });
                return true;
              } catch (error) {
                if (error.status === 404) return false;
                throw error;
              }
            }

            const hotfixBase = hotfixBranch.split("/").pop();
            const stagingBranch = `backport/${hotfixBase}-to-staging`;
            const developBranch = `backport/${hotfixBase}-to-develop`;
            const repoUrl = `https://github.com/${owner}/${repo}`;

            const stagingExists = await branchExists(stagingBranch);
            const developExists = await branchExists(developBranch);

            // --- 5. Build SOP blocks ---
            function buildBlock(target, branchName, exists) {
              const base = target.toLowerCase();

              if (exists) {
                return [
                  `### ${target} Backport`,
                  "<details>",
                  `  <summary>‚ö†Ô∏è Branch already exists: \`${branchName}\`</summary>`,
                  "",
                  `‚û°Ô∏è Open PR if needed: [\`${branchName} ‚Üí ${base}\`](${repoUrl}/compare/${base}...${branchName})`,
                  "",
                  "</details>",
                ].join('\n');
              }

              return [
                `### ${target} Backport`,
                "<details>",
                "  <summary>Create backport branch ‚Üí Open PR</summary>",
                "",
                "```bash",
                `git checkout ${base}`,
                `git pull origin ${base}`,
                `git checkout -b ${branchName}`,
                `git merge ${hotfixBranch}`,
                `git push origin ${branchName}`,
                "```",
                "",
                `‚û°Ô∏è Create PR: [\`${branchName} ‚Üí ${base}\`](${repoUrl}/compare/${base}...${branchName})`,
                "",
                "</details>",
              ].join('\n');
            }

            const blockSetup = [
              "### üîß 1. Sync Local Main",
              "```bash",
              "git checkout main",
              "git pull origin main",
              "```",
            ].join('\n');

            const blockStaging = buildBlock("STAGING", stagingBranch, stagingExists);
            const blockDevelop = buildBlock("DEVELOP", developBranch, developExists);

            const blockCleanup = [
              "### üßπ 4. Cleanup (After ALL Backports Are Merged)",
              "```bash",
              `git branch -D ${hotfixBranch}`,
              `git push origin :${hotfixBranch}`,
              "```",
            ].join('\n');

            const caveat = [
              "---",
              "### ‚ö†Ô∏è IMPORTANT SAFETY WARNING",
              "- Inspect merge conflicts manually.",
              "- Confirm branch names before pushing.",
              "- Do NOT delete the hotfix branch until **all** backports are merged.",
            ].join("\n");

            // --- 6. Final SOP message assembly ---
            const message = [
              `## üî• Hotfix Propagation SOP: \`${hotfixBranch}\``,
              `A hotfix has been merged into **main**. Follow the steps below to propagate it.`,
              "---",
              blockSetup,
              blockStaging,
              blockDevelop,
              blockCleanup,
              caveat,
            ].join('\n\n'); // Use double newline separation

            // --- 7. Post comment ---
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: originalPrNumber,
              body: message,
            });

            core.info(`SOP posted on PR #${originalPrNumber}.`);