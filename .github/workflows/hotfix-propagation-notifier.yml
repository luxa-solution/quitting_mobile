name: Hotfix Propagation Notifier

on:
  push:
    branches:
      - main   # Trigger when main receives new commits (from merges)

jobs:
  generate_sop:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write     # Needed for PR comments & labels

    steps:
      - name: Generate Hotfix Propagation SOP
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

          script: |
            const { owner, repo } = context.repo;
            const commitSha = context.sha;

            core.info(`Processing push to main with commit ${commitSha}`);

            // ===============================================================
            // 1. STRICT PR LOOKUP USING merge_commit_sha
            // ===============================================================
            // Works for:
            // - Merge commits
            // - Squash merges
            // - Rebase merges
            // AND requires NO looping or commit ancestry logic.
            // ===============================================================

            const { data: result } = await github.rest.search.issuesAndPullRequests({
              q: `merged:${commitSha} type:pr base:main repo:${owner}/${repo}`,
              sort: "updated",
              order: "desc",
              per_page: 1,
            });

            if (result.total_count === 0) {
              core.info(`No PR found with merge_commit_sha = ${commitSha}. Exiting.`);
              return;
            }

            const originalPrNumber = result.items[0].number;

            core.info(`Matched PR #${originalPrNumber} via merge_commit_sha.`);

            // ===============================================================
            // 2. Fetch PR details
            // ===============================================================

            const { data: mergedPr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: originalPrNumber,
            });

            const hotfixBranch = mergedPr.head.ref;

            // ===============================================================
            // 3. Validate hotfix/* branch
            // ===============================================================

            if (!hotfixBranch.startsWith("hotfix/")) {
              core.info(`PR #${originalPrNumber} is NOT from hotfix/* (${hotfixBranch}). Exiting.`);
              return;
            }

            core.info(`Hotfix PR #${originalPrNumber} detected: ${hotfixBranch}`);

            // ===============================================================
            // 4. Apply label: needs-backport
            // ===============================================================

            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: originalPrNumber,
                labels: ["needs-backport"],
              });
              core.info(`Applied label: needs-backport`);
            } catch (err) {
              core.warning(`Could not apply label: ${err.message}`);
            }

            // ===============================================================
            // 5. Compute branch names + check existence
            // ===============================================================

            const hotfixBase = hotfixBranch.split("/").pop();
            const stagingBranch = `backport/${hotfixBase}-to-staging`;
            const developBranch = `backport/${hotfixBase}-to-develop`;
            const repoUrl = `https://github.com/${owner}/${repo}`;

            async function branchExists(branch) {
              try {
                await github.rest.repos.getBranch({ owner, repo, branch });
                return true;
              } catch (error) {
                // Only ignore 404 (branch not found)
                if (error.status === 404) return false;
                throw error;
              }
            }

            const stagingExists = await branchExists(stagingBranch);
            const developExists = await branchExists(developBranch);

            core.info(
              `Branch existence ‚Üí staging:${stagingExists}, develop:${developExists}`
            );

            // ===============================================================
            // 6. Build SOP blocks
            // ===============================================================

            const blockSetup = `
            ### üîß 1. Sync Local \`main\`
            \`\`\`bash
            git checkout main
            git pull origin main
            \`\`\`
            `;

            function buildBackportBlock(target, branchName, exists) {
              const base = target.toLowerCase();

              if (exists) {
                return `
                ### ${target} Backport
                <details>
                <summary>‚ö†Ô∏è Branch already exists: <code>${branchName}</code></summary>

                ‚û°Ô∏è Open or inspect PR:  
                [\`${branchName} ‚Üí ${base}\`](${repoUrl}/compare/${base}...${branchName})

                </details>
                `;
              }

              return `
              ### ${target} Backport
              <details>
              <summary>Create backport branch ‚Üí Open PR</summary>

              \`\`\`bash
              git checkout ${base}
              git pull origin ${base}

              git checkout -b ${branchName}
              git merge ${hotfixBranch}

              git push origin ${branchName}
              \`\`\`

              ‚û°Ô∏è Create PR:  
              [\`${branchName} ‚Üí ${base}\`](${repoUrl}/compare/${base}...${branchName})

              </details>
              `;
            }

            const blockStaging = buildBackportBlock("STAGING", stagingBranch, stagingExists);
            const blockDevelop = buildBackportBlock("DEVELOP", developBranch, developExists);

            const blockCleanup = `
            ### üßπ 4. Cleanup (After ALL Backport PRs Are Merged)
            <details>
            <summary>Remove hotfix branches</summary>

            \`\`\`bash
            git branch -D ${hotfixBranch}
            git push origin :${hotfixBranch}
            \`\`\`

            ‚ö†Ô∏è Remove backport branches from GitHub UI after merging.

            </details>
            `;

            const caveat = `
            ---
            ### ‚ö†Ô∏è SAFETY WARNINGS
            - Inspect merge conflicts manually.
            - Verify branch names before pushing.
            - Do NOT delete the hotfix branch prematurely.
            `;

            const message = `
            ## üî• Hotfix Propagation SOP: \`${hotfixBranch}\`

            A hotfix has been merged into **\`main\`**.  
            Follow this propagation guide:

            ---

            ${blockSetup}
            ${blockStaging}
            ${blockDevelop}
            ${blockCleanup}
            ${caveat}
            `;

            // ===============================================================
            // 7. Post SOP as a comment
            // ===============================================================

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: originalPrNumber,
              body: message,
            });

            core.info(`Successfully posted propagation SOP for PR #${originalPrNumber}.`);
