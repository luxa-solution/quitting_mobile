name: PR Branch Semantics Guard

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - develop
      - staging
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  branch-semantics-guard:
    name: branch-semantics-guard
    runs-on: ubuntu-latest

    steps:
      - name: Enforce branch semantics vs change scope
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) return;

            const branch = pr.head.ref;
            const base = pr.base.ref;
            const labels = pr.labels.map(l => l.name);

            // Escape hatch

            if (labels.includes('override-scope-guard')) {
              core.warning('Branch Semantics Guard overridden via label.');
              return;
            }

            // Collect changed files (with pagination)
            
            const files = [];
            let page = 1;

            while (true) {
              const { data } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                per_page: 100,
                page,
              });

              if (data.length === 0) break;
              files.push(...data.map(f => f.filename));
              page++;
            }

            // Domain classification
            
            const touches = {
              src: files.some(p => p.startsWith('src/')),
              assets: files.some(p => p.startsWith('assets/')),
              docs: files.some(p => p.startsWith('docs/') || p === 'README.md'),

              infra: files.some(p =>
                p.startsWith('.github/') ||
                p.startsWith('.husky/') ||
                p.startsWith('.vscode/') ||
                p === 'branch-protection-ruleset.json'
              ),

              expo: files.some(p =>
                ['app.json', 'eas.json', 'index.js', 'expo-env.d.ts'].includes(p)
              ),

              deps: files.some(p =>
                ['package.json', 'pnpm-lock.yaml', '.npmrc'].includes(p)
              ),
            };

            const errors = [];
            const warnings = [];

            // ðŸ”´ HARD ERROR RULES

            // docs/*
            if (
              branch.startsWith('docs/') &&
              (touches.src || touches.assets || touches.infra || touches.expo || touches.deps)
            ) {
              errors.push('`docs/*` branches must only modify documentation files.');
            }

            // chore/*
            if (
              branch.startsWith('chore/') &&
              (touches.src || touches.assets)
            ) {
              errors.push('`chore/*` branches must not modify application code (`src/` or `assets/`).');
            }

            // refactor/*
            if (
              branch.startsWith('refactor/') &&
              touches.infra
            ) {
              errors.push('`refactor/*` branches must not modify CI or tooling files.');
            }

            // ðŸŸ¡ WARNING RULES            

            // feature / bugfix touching infra
            if (
              (branch.startsWith('feature/') || branch.startsWith('bugfix/')) &&
              touches.infra
            ) {
              warnings.push(
                'Feature/bugfix branch modifies CI or tooling files â€” verify this is intentional.'
              );
            }

            // feature touching Expo config
            if (branch.startsWith('feature/') && touches.expo) {
              warnings.push(
                'Feature branch modifies Expo build/runtime config (`app.json`, `eas.json`).'
              );
            }

            // dependency changes
            if (touches.deps) {
              warnings.push(
                'Dependency files changed â€” review for unintended version drift.'
              );
            }

            // hotfix/* and release/* are intentionally unrestricted

            
            // Reporting
            
            let body = `## ðŸ” Branch Semantics Guard\n\n`;
            body += `**Source branch:** \`${branch}\`\n`;
            body += `**Target branch:** \`${base}\`\n\n`;

            if (errors.length) {
              body += `### âŒ Errors (must fix)\n`;
              errors.forEach(e => body += `- ${e}\n`);
              body += '\n';
            }

            if (warnings.length) {
              body += `### âš ï¸ Warnings\n`;
              warnings.forEach(w => body += `- ${w}\n`);
              body += '\n';
            }

            if (!errors.length && !warnings.length) {
              body += `âœ… No branch semantics issues detected.\n`;
            }

            body += `\n---\n`;
            body += `> Add the label \`override-scope-guard\` to bypass this check if the changes are intentional.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body,
            });

            if (errors.length) {
              core.setFailed('Branch Semantics Guard failed.');
            } else if (warnings.length) {
              core.warning('Branch Semantics Guard warnings present.');
            }
