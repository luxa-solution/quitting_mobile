name: PR Branch Guard

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches:
      - '**'

permissions:
  contents: read
  pull-requests: write

jobs:
  branch-guard:
    name: branch-guard
    runs-on: ubuntu-latest
    steps:
      - name: Enforce PR Branch Flow Rules
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No pull_request payload found; skipping branch guard.');
              return;
            }

            const base = pr.base.ref; // target branch
            const head = pr.head.ref; // source branch
            const prNumber = pr.number;

            core.info(`Branch Guard: checking PR #${prNumber}: ${head} -> ${base}`);

            const startsWithOneOf = (branch, prefixes) =>
              prefixes.some(prefix => branch.startsWith(prefix));

            let allowed = true;
            let explanation = '';

            if (base === 'main') {
              // main: only from staging, hotfix/*, release/*
              allowed =
                head === 'staging' ||
                head === 'release' ||
                head.startsWith('hotfix/') ||
                head.startsWith('release/');

              explanation = [
                'Allowed PR sources into `main`:',
                '- `staging`',
                '- `release`',
                '- `hotfix/*`',
                '- `release/*`',
              ].join('\n');

            } else if (base === 'staging') {
              // staging: only from develop OR hotfix/*
              allowed = head === 'develop' || head.startsWith('hotfix/');
              explanation = [
                'Allowed PR sources into `staging`:',
                '- `develop` (Standard Integration Flow)',
                '- `hotfix/*` (Direct Hotfix Propagation)',
              ].join('\n');

            } else if (base === 'develop') {
              // develop: feature/*, bugfix/*, ... OR hotfix/*
              const allowedPrefixes = [
                'feature/',
                'bugfix/',
                'release/',
                'refactor/',
                'docs/',
                'test/',
                'chore/',
                'hotfix/',
              ];

              allowed = startsWithOneOf(head, allowedPrefixes);

              explanation = [
                'Allowed PR sources into `develop`:',
                '- `feature/*`, `bugfix/*`, `refactor/*`, `docs/*`, `test/*`, `chore/*` (New Work)',
                '- `hotfix/*` (Standard Development and Hotfix Propagation)',
                '- `release/*` (Cross-Propagation)',
              ].join('\n');
            } else {
              core.info(`Branch Guard: no rules defined for target "${base}", skipping validation.`);
              return;
            }

            if (!allowed) {
              const message = [
                '[Blocked] **Branch flow violation**',
                '',
                `This pull request is not allowed based on the repository branch strategy.`,
                '',
                `**From:** \`${head}\``,
                `**To:** \`${base}\``,
                '',
                explanation,
                '',
                '> Please re-open a PR from an allowed source branch for this target.',
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: message,
              });

              // Auto-close the PR to prevent merge
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                state: 'closed',
              });

              core.setFailed(`Disallowed PR: ${head} -> ${base}`);
            } else {
              core.info(`Branch Guard: PR #${prNumber}: ${head} -> ${base} is allowed (passed)`);
            }
