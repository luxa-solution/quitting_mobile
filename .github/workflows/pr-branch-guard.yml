# .github/workflows/pr-branch-guard.yml
name: PR Branch Guard

on:
  workflow_call:
    inputs:
      head_ref:
        required: true
        type: string
        description: The source branch name (e.g., feature/xyz)
      base_ref:
        required: true
        type: string
        description: The target branch name (e.g., develop)
      pr_number:
        required: true
        type: number
        description: The number of the Pull Request (use 0 if not a PR)
      event_name: 
        required: true
        type: string
        description: The GitHub event that triggered the workflow

permissions:
  contents: read
  pull-requests: write 

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Enforce PR Branch Flow Rules
        # Runs ONLY on PR events to check head -> base relationship and perform PR actions.
        if: ${{ inputs.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const base = '${{ inputs.base_ref }}'; // target branch
            const head = '${{ inputs.head_ref }}'; // source branch
            const prNumber = ${{ inputs.pr_number }};

            core.info(`Branch Guard: checking PR #${prNumber}: ${head} -> ${base}`);

            // Helper: does head start with any prefix in list?
            const startsWithOneOf = (branch, prefixes) =>
              prefixes.some(prefix => branch.startsWith(prefix));

            let allowed = true;
            let explanation = '';

            if (base === 'main') {
              // main: only from staging, hotfix/*, release/*
              allowed =
                head === 'staging' ||
                head === 'release' ||               
                head.startsWith('hotfix/') ||
                head.startsWith('release/');

              explanation = [
                'Allowed PR sources into `main`:',
                '- `staging`',
                '- `hotfix/*`',
                '- `release/*`',
              ].join('\n');

            } else if (base === 'staging') {
              // staging: only from develop
              allowed = head === 'develop';
              explanation = [
                'Allowed PR sources into `staging`:',
                '- `develop`',
              ].join('\n');

            } else if (base === 'develop') {
              // develop: feature/*, bugfix/*, hotfix/*, release/*, refactor/*, docs/*, test/*, chore/*
              const allowedPrefixes = [
                'feature/',
                'bugfix/',
                'hotfix/',
                'release/',
                'refactor/',
                'docs/',
                'test/',
                'chore/',
              ];

              allowed = startsWithOneOf(head, allowedPrefixes);

              explanation = [
                'Allowed PR sources into `develop`:',
                '- `feature/*`',
                '- `bugfix/*`',
                '- `hotfix/*`',
                '- `release/*`',
                '- `refactor/*`',
                '- `docs/*`',
                '- `test/*`',
                '- `chore/*`',
              ].join('\n');
            } else {
              core.info(`Branch Guard: no rules defined for target "${base}", skipping validation.`);
              return;
            }

            if (!allowed) {
              const message = [
                'ðŸš« **Branch flow violation**',
                '',
                `This pull request is not allowed based on the repository branch strategy.`,
                '',
                `**From:** \`${head}\``,
                `**To:** \`${base}\``,
                '',
                explanation,
                '',
                '> Please re-open a PR from an allowed source branch for this target.',
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: message,
              });
              
              // Auto-close the PR to prevent merge
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                state: 'closed',
              });

              core.setFailed(`Disallowed PR: ${head} -> ${base}`);
            } else {
              core.info(`Branch Guard: PR #${prNumber}: ${head} -> ${base} is allowed âœ…`);
            }
      
      - name: Allow non-PR events to succeed
        # This step runs ONLY on non-PR events (push, dispatch, schedule) to ensure the job result is 'success'
        if: ${{ inputs.event_name != 'pull_request' }}
        run: echo "Event ${{ inputs.event_name }} is not a Pull Request, allowing downstream jobs to proceed."